// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Đã cấu hình cho MongoDB
datasource db {
  provider = "mongodb"
  url      = env("MONGODB_URI")
}

// ----------------------------------------
// Enums (Định nghĩa các kiểu dữ liệu cố định)
// ----------------------------------------

enum Role {
  STUDENT
  TUTOR
  COORDINATOR
  PROGRAM_ADMIN
  DEPARTMENT_CHAIR
  STUDENT_AFFAIRS
}

// CHANGED: Thêm Enum cho TutorStatus (thay vì dùng String)
enum TutorStatus {
  AVAILABLE
  AT_CAPACITY
  UNAVAILABLE
}

enum SessionStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELED
  NO_SHOW
}

enum ConflictSeverity {
  HIGH
  MEDIUM
  LOW
}

enum AuditAction {
  LOGIN
  LOGOUT
  MANUAL_ASSIGNMENT_CREATE
  CONFLICT_RESOLVE
  SESSION_BOOK
  SESSION_CANCEL
  ROLE_UPDATE
  USER_CREATE
  REPORT_EXPORT
  SYSTEM_TASK_RUN
}

// ----------------------------------------
// Models Xác thực & Vai trò (Auth & Roles)
// ----------------------------------------

model User {
  id        String @id @map("_id") @default(auto()) @db.ObjectId
  email     String @unique
  fullName  String
  
  hashedPassword String?
  isActive  Boolean  @default(true)

  role     Role   @default(STUDENT)

  // --- Liên kết 1-1 đến các "Hồ sơ" (Profiles) nghiệp vụ ---
  studentProfile     StudentProfile?
  tutorProfile       TutorProfile?
  coordinatorProfile CoordinatorProfile?

  // --- Quan hệ nghiệp vụ (do User này thực hiện) ---
  auditLogs      AuditLog[]
  createdQuizzes Quiz[]
  feedbackSent   Feedback[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Optional: track the last successful login time for quick audit and cleanup
  lastLoginAt DateTime?
}

// ----------------------------------------
// Models Hồ sơ Nghiệp vụ (Business Profiles)
// ----------------------------------------

model StudentProfile {
  id        String @id @map("_id") @default(auto()) @db.ObjectId
  studentId String @unique
  program   String?
  faculty   String?
  year      Int?
  metadata  Json?

  // Liên kết 1-1 ngược lại với User
  user   User   @relation(fields: [userId], references: [id])
  userId String @unique @db.ObjectId

  // --- Quan hệ nghiệp vụ (của Student này) ---
  sessions    Session[]
  assignments ManualAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // `userId` is already marked `@unique` which creates an index; avoid duplicate @@index
}

model TutorProfile {
  id             String @id @map("_id") @default(auto()) @db.ObjectId
  tutorId        String @unique
  profileSummary String?
  
  // CHANGED: Chuyển từ String sang Enum
  status         TutorStatus @default(AVAILABLE)
  
  // Liên kết 1-1 ngược lại với User
  user   User   @relation(fields: [userId], references: [id])
  userId String @unique @db.ObjectId

  // --- Quan hệ nghiệp vụ (của Tutor này) ---
  sessions         Session[]
  assignments      ManualAssignment[]
  conflicts        Conflict[]
  availability     AvailabilitySlot[]
  expertise        ExpertiseOnTutors[] // Bảng join M-N

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // `userId` is already marked `@unique` which creates an index; avoid duplicate @@index
}

model CoordinatorProfile {
  id         String @id @map("_id") @default(auto()) @db.ObjectId
  staffId    String @unique
  department String?

  // Liên kết 1-1 ngược lại với User
  user   User   @relation(fields: [userId], references: [id])
  userId String @unique @db.ObjectId

  // --- Quan hệ nghiệp vụ (của Coordinator này) ---
  assignmentsCreated ManualAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // `userId` is already marked `@unique` which creates an index; avoid duplicate @@index
}

// ----------------------------------------
// Models Nghiệp vụ (Business Logic Models)
// ----------------------------------------

model Session {
  id        String    @id @map("_id") @default(auto()) @db.ObjectId
  datetime  DateTime
  notes     String?
  status    SessionStatus @default(PENDING)

  // Liên kết nghiệp vụ
  student   StudentProfile @relation(fields: [studentProfileId], references: [id])
  studentProfileId String @db.ObjectId
  
  // Tutor là optional (phiên có thể PENDING mà chưa có tutor)
  tutor     TutorProfile?   @relation(fields: [tutorProfileId], references: [id])
  tutorProfileId String?    @db.ObjectId
  
  feedback  Feedback?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentProfileId])
  @@index([tutorProfileId])
  @@index([status])
}

model ManualAssignment {
  id              String      @id @map("_id") @default(auto()) @db.ObjectId
  reason          String
  suggestionContext Json?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  // Optional: when the assignment was actually performed/assigned
  assignedAt      DateTime?
  
  // Liên kết nghiệp vụ
  student         StudentProfile     @relation(fields: [studentProfileId], references: [id])
  studentProfileId  String             @db.ObjectId
  
  tutor           TutorProfile       @relation(fields: [tutorProfileId], references: [id])
  tutorProfileId    String             @db.ObjectId
  
  coordinator     CoordinatorProfile @relation(fields: [coordinatorProfileId], references: [id])
  coordinatorProfileId String           @db.ObjectId
  
  @@index([studentProfileId])
  @@index([tutorProfileId])
  @@index([coordinatorProfileId])
}

model Conflict {
  id         String    @id @map("_id") @default(auto()) @db.ObjectId
  type       String
  slot       String
  details    String?
  severity   ConflictSeverity
  detectedAt DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Gia sư bị ảnh hưởng (nếu có)
  tutor        TutorProfile? @relation(fields: [tutorProfileId], references: [id])
  tutorProfileId String?     @db.ObjectId
  
  // Các yêu cầu (requests) bị ảnh hưởng
  requests     ConflictRequest[]
  
  @@index([tutorProfileId])
}

model ConflictRequest {
  id         String   @id @map("_id") @default(auto()) @db.ObjectId
  
  conflict   Conflict @relation(fields: [conflictId], references: [id])
  conflictId String   @db.ObjectId

  // Dữ liệu snapshot
  requestId   String
  studentName String
  studentId   String
  course      String
  status      String

  @@index([conflictId])
}

model Feedback {
  id        String   @id @map("_id") @default(auto()) @db.ObjectId
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  session   Session  @relation(fields: [sessionId], references: [id])
  sessionId String   @unique @db.ObjectId

  submittedBy User     @relation(fields: [submittedById], references: [id])
  submittedById String @db.ObjectId

  // `sessionId` is unique; explicit index not required. Keep index on submittedById only if needed.
  @@index([submittedById])
}

model AuditLog {
  id        String   @id @map("_id") @default(auto()) @db.ObjectId
  action    AuditAction
  targetType String
  targetId   String?
  details   Json?
  // Snapshot of the actor's roles at time of action; useful for auditing
  actorRoles Json?
  createdAt DateTime @default(now())

  actor     User     @relation(fields: [actorId], references: [id])
  actorId   String   @db.ObjectId
  
  @@index([actorId])
  @@index([targetType])
  @@index([targetId])
}

// ----------------------------------------
// Models Hỗ trợ (Supporting Models - Fix Json)
// ----------------------------------------

model ExpertiseItem {
  id     String       @id @map("_id") @default(auto()) @db.ObjectId
  name   String       @unique
  tutors ExpertiseOnTutors[]
}

// FIXED: Sửa lỗi khóa chính tổng hợp (Composite Key)
// Thay thế @@id bằng id (ObjectId) và @@unique
model ExpertiseOnTutors {
  id              String        @id @map("_id") @default(auto()) @db.ObjectId
  
  tutor           TutorProfile  @relation(fields: [tutorProfileId], references: [id])
  tutorProfileId  String        @db.ObjectId
  
  expertise       ExpertiseItem @relation(fields: [expertiseItemId], references: [id])
  expertiseItemId String        @db.ObjectId
  
  @@index([expertiseItemId])
  @@index([tutorProfileId])
  // Đảm bảo không thể gán 1 expertise 2 lần cho 1 tutor
  // NOTE: composite unique indexes/constraints may have limited support with
  // Prisma's Mongo connector. If `prisma db push` fails here, remove or
  // comment out the following @@unique and instead create a unique index
  // directly in Mongo (db.collection.createIndex(..., { unique: true })) or
  // enforce uniqueness in the application/seed logic.
  @@unique([tutorProfileId, expertiseItemId]) 
}

model AvailabilitySlot {
  id     String @id @map("_id") @default(auto()) @db.ObjectId
  day    String
  time   String
  mode   String

  tutor  TutorProfile @relation(fields: [tutorProfileId], references: [id])
  tutorProfileId String @db.ObjectId
  
  @@index([tutorProfileId])
}

// ----------------------------------------
// Models Tính năng (Feature Models - Fix Json)
// ----------------------------------------

model Quiz {
  id          String   @id @map("_id") @default(auto()) @db.ObjectId
  generatedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt
  topic       String
  difficulty  String

  createdBy   User     @relation(fields: [createdById], references: [id])
  createdById String   @db.ObjectId

  questions   QuestionItem[]
  
  @@index([createdById])
}

model QuestionItem {
  id           String   @id @map("_id") @default(auto()) @db.ObjectId
  questionText String
  options      String[]
  correctIndex Int?     // Optional (có thể null)
  explanation  String?
  source       String

  quiz         Quiz     @relation(fields: [quizId], references: [id])
  quizId       String   @db.ObjectId

  @@index([quizId])
}